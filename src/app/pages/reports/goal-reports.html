<app-page-header [pageTitle]="pageTitle" [backRoute]="'/reportes'"></app-page-header>

<div class="report-container">
  <app-custom-select
    [labelKey]="'salesReportVendorLabel'"
    [options]="vendedores()"
    [model]="vendedor"
    [required]="true"
    (modelChange)="onSelectionChange()"
  ></app-custom-select>

  <app-custom-select
    [labelKey]="'salesPlanQuarterLabel'"
    [options]="quarters"
    [model]="quarter"
    [required]="true"
    (modelChange)="onSelectionChange()"
    style="margin-top: 20px"
  ></app-custom-select>

  <app-custom-select
    [labelKey]="'region_label'"
    [options]="regionOptions"
    [model]="region"
    [required]="true"
    (modelChange)="onSelectionChange()"
    style="margin-top: 20px"
  ></app-custom-select>

  <div class="button-container">
    <button mat-flat-button color="primary" [disabled]="isButtonDisabled" (click)="generarReporte()">
      {{ 'goalReportButton' | translate }}
    </button>
  </div>

  <app-status-message
    *ngIf="showMessage()"
    [type]="messageType()"
    [messageKey]="messageText()"
    [float]="true"
    [duration]="messageType() === 'error' ? 8000 : 4000"
  ></app-status-message>

  <div *ngIf="reportData()" class="compliance-report">
    <div class="report-header">
      <h2>{{ 'goalReportTitle' | translate }}</h2>
      <div class="compliance-percentage">
        <span class="percentage-value">{{ getCumplimientoTotalPct() | number:'1.2-2' }}%</span>
        <span class="percentage-label">{{ 'goalReportVendorCompliance' | translate }}</span>
      </div>
    </div>

    <div class="report-info">
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">{{ 'goalReportPeriod' | translate }}:</span>
          <span class="info-value">{{ formatDate(reportData().period_start) }} - {{ formatDate(reportData().period_end) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">{{ 'goalReportOrders' | translate }}:</span>
          <span class="info-value">{{ formatNumber(reportData().pedidos || 0) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">{{ 'goalReportVendorId' | translate }}:</span>
          <span class="info-value">{{ reportData().vendor_id }}</span>
        </div>
      </div>
      <div class="info-row" *ngIf="reportData().region">
        <div class="info-item">
          <span class="info-label">{{ 'goalReportRegionLabel' | translate }}:</span>
          <span class="info-value">{{ reportData().region }}</span>
        </div>
        <div class="info-item" *ngIf="reportData().ventas_region">
          <span class="info-label">{{ 'goalReportRegionSales' | translate }}:</span>
          <span class="info-value highlight">{{ formatPrice(reportData().ventas_region) }}</span>
        </div>
        <div class="info-item" *ngIf="reportData().cumplimiento_region_pct !== undefined">
          <span class="info-label">{{ 'goalReportRegionCompliance' | translate }}:</span>
          <span class="info-value">{{ getCumplimientoRegionPct() | number:'1.2-2' }}%</span>
        </div>
      </div>
      <div class="info-row" *ngIf="reportData().num_sellers_region || reportData().num_plans_active">
        <div class="info-item" *ngIf="reportData().num_sellers_region">
          <span class="info-label">{{ 'goalReportSellersInRegion' | translate }}:</span>
          <span class="info-value">{{ reportData().num_sellers_region }}</span>
        </div>

        <div class="info-item" *ngIf="reportData().total_goal">
          <span class="info-label">{{ 'goalReportIndividualVendorGoal' | translate }}:</span>
          <span class="info-value">{{ formatPrice(reportData().total_goal || 0) }}</span>
        </div>

        <div class="info-item" *ngIf="reportData().total_goal">
          <span class="info-label">{{ 'goalReportTotalRegionGoal' | translate }}:</span>
          <span class="info-value">{{ formatPrice(reportData().total_goal || 0) }}</span>
        </div>

        <div class="info-item" *ngIf="reportData().num_plans_active">
          <span class="info-label">{{ 'goalReportActivePlans' | translate }}:</span>
          <span class="info-value">{{ reportData().num_plans_active }}</span>
        </div>
      </div>
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">{{ 'goalReportTotalSales' | translate }}:</span>
          <span class="info-value highlight">{{ formatPrice(getSummaryStats().totalSales) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">{{ 'goalReportTotalGoal' | translate }}:</span>
          <span class="info-value">{{ formatPrice(getSummaryStats().totalGoal) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">{{ 'goalReportDifference' | translate }}:</span>
          <span class="info-value" [class.positive]="getSummaryStats().difference >= 0" [class.negative]="getSummaryStats().difference < 0">
            {{ getSummaryStats().difference >= 0 ? '+' : '' }}{{ formatPrice(getSummaryStats().difference >= 0 ? getSummaryStats().difference : -getSummaryStats().difference) }}
          </span>
        </div>
      </div>
    </div>

    <div class="summary-stats" *ngIf="getDetalleProductos().length > 0">
      <h3 class="section-title-small">{{ 'goalReportSummary' | translate }}</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">{{ getSummaryStats().totalProducts }}</div>
          <div class="stat-label">{{ 'goalReportTotalProducts' | translate }}</div>
        </div>
        <div class="stat-card completed">
          <div class="stat-value">{{ getSummaryStats().productsCompleted }}</div>
          <div class="stat-label">{{ 'goalReportCompleted' | translate }}</div>
        </div>
        <div class="stat-card in-progress">
          <div class="stat-value">{{ getSummaryStats().productsInProgress }}</div>
          <div class="stat-label">{{ 'goalReportInProgress' | translate }}</div>
        </div>
        <div class="stat-card not-completed">
          <div class="stat-value">{{ getSummaryStats().productsNotCompleted }}</div>
          <div class="stat-label">{{ 'goalReportNotCompleted' | translate }}</div>
        </div>
        <div class="stat-card" [ngClass]="{
          'completed': getProductsWithGoalStatus() === 'verde',
          'in-progress': getProductsWithGoalStatus() === 'amarillo',
          'not-completed': getProductsWithGoalStatus() === 'rojo'
        }">
          <div class="stat-value">{{ getSummaryStats().productsWithGoal }}</div>
          <div class="stat-label">{{ 'goalReportWithGoal' | translate }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ getSummaryStats().productsWithoutGoal }}</div>
          <div class="stat-label">{{ 'goalReportWithoutGoal' | translate }}</div>
        </div>
      </div>
    </div>

    <div class="metrics-container">
      <div class="metric-item">
        <div class="metric-header">
          <span class="metric-label">{{ 'goalReportProduct' | translate }}</span>
          <span class="metric-value">
            {{ formatPrice(getAggregatedMetrics().producto.achieved) }} / {{ formatPrice(getAggregatedMetrics().producto.goal) }}
          </span>
        </div>
        <div class="progress-bar-container">
          <div
            class="progress-bar"
            [class]="'progress-bar ' + getStatusColor(getProductStatus())"
            [style.width.%]="getProgressPercentage(getAggregatedMetrics().producto.achieved, getAggregatedMetrics().producto.goal)">
          </div>
        </div>
      </div>

      <div class="metric-item">
        <div class="metric-header">
          <span class="metric-label">{{ 'goalReportRegion' | translate }}</span>
          <span class="metric-value">
            {{ formatPrice(getAggregatedMetrics().region.achieved) }} / {{ formatPrice(getAggregatedMetrics().region.goal) }}
          </span>
        </div>
        <div class="progress-bar-container">
          <div
            class="progress-bar"
            [class]="'progress-bar ' + getStatusColor(getRegionStatus())"
            [style.width.%]="getProgressPercentage(getAggregatedMetrics().region.achieved, getAggregatedMetrics().region.goal)">
          </div>
        </div>
      </div>

      <div class="metric-item">
        <div class="metric-header">
          <span class="metric-label">{{ 'goalReportTotal' | translate }}</span>
          <span class="metric-value">
            {{ formatPrice(getAggregatedMetrics().total.achieved) }} / {{ formatPrice(getAggregatedMetrics().total.goal) }}
          </span>
        </div>
        <div class="progress-bar-container">
          <div
            class="progress-bar"
            [class]="'progress-bar ' + getStatusColor(getTotalStatus())"
            [style.width.%]="getProgressPercentage(getAggregatedMetrics().total.achieved, getAggregatedMetrics().total.goal)">
          </div>
        </div>
      </div>
    </div>

    <div class="products-detail-section" *ngIf="getDetalleProductos().length > 0">
      <h3 class="section-title">{{ 'goalReportProductsDetail' | translate }}</h3>
      <div class="table-container">
        <table class="products-table">
          <thead>
          <tr>
            <th>{{ 'goalReportProductId' | translate }}</th>
            <th>{{ 'goalReportSales' | translate }}</th>
            <th>{{ 'goalReportGoal' | translate }}</th>
            <th>{{ 'goalReportCompliance' | translate }}</th>
            <th>{{ 'goalReportStatus' | translate }}</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let product of getDetalleProductosSorted()" [class]="'status-' + getProductCalculatedStatus(product)">
            <td class="product-id">{{ product.product_id }}</td>
            <td class="sales-value">{{ formatPrice(product.ventas || 0) }}</td>

            <td class="goal-value">
                <span *ngIf="product.goal && product.goal > 0">
                  {{ formatPrice(product.goal) }}
                </span>
              <span *ngIf="!product.goal || product.goal === 0" class="no-goal">
                  {{ 'goalReportNoGoal' | translate }}
                </span>
            </td>

            <td class="compliance-value">
                <span *ngIf="product.goal && product.goal > 0" [class.high-compliance]="getProductCumplimientoPct(product) >= 100">
                  {{ getProductCumplimientoPct(product) | number:'1.2-2' }}%
                </span>
              <span *ngIf="!product.goal || product.goal === 0" class="no-goal">
                  {{ 'goalReportNoGoal' | translate }}
                </span>
            </td>
            <td class="status-cell">
                <span class="status-badge" [class]="'status-' + getProductCalculatedStatus(product)">
                  {{ getStatusLabel(getProductCalculatedStatus(product)) }}
                </span>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
