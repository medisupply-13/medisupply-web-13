<app-page-header [pageTitle]="pageTitle" [backRoute]="'/productos'"></app-page-header>

<section class="content">

  <app-status-message
    *ngIf="message"
    [type]="message.type"
    [messageKey]="message.key"
    [float]="true">
  </app-status-message>

  <!-- Barra de búsqueda -->
  <div class="search-section">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>{{ 'searchProductLabel' | translate }}</mat-label>
      <input 
        matInput 
        [(ngModel)]="searchQuery"
        (keyup.enter)="onSearch()"
        [placeholder]="'searchProductPlaceholder' | translate">
      <mat-icon matSuffix (click)="onSearch()" class="search-icon">search</mat-icon>
    </mat-form-field>
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="filter-row">
      <app-custom-select
        [labelKey]="'cityLabel'"
        [placeholderKey]="'cityPlaceholder'"
        [options]="cityOptions"
        [model]="selectedCity"
        (modelChange)="onCityChange()"
        name="city">
      </app-custom-select>

      <app-custom-select
        [labelKey]="'warehouseLabel'"
        [placeholderKey]="'warehousePlaceholder'"
        [options]="warehouseOptions"
        [model]="selectedWarehouse"
        (modelChange)="onWarehouseChange()"
        name="warehouse">
      </app-custom-select>
    </div>
  </div>

  <!-- Panel de Resultados -->
  <div class="results-panel" *ngIf="filteredProducts.length > 0">
    <!-- Header del Panel -->
    <div class="panel-header">
      <div class="panel-title">
        <mat-icon>inventory_2</mat-icon>
        <h3>{{ 'productsFoundTitle' | translate }} ({{ getTotalFilteredProducts() }})</h3>
        <span class="sort-indicator" *ngIf="sortBy !== 'none'">
          <mat-icon>{{ getSortIcon() }}</mat-icon>
          <span>{{ getSortLabel() }}</span>
        </span>
      </div>
      <div class="panel-actions">
        <button mat-icon-button (click)="toggleViewMode()" [title]="(viewMode === 'grid' ? 'viewListTitle' : 'viewGridTitle') | translate">
          <mat-icon>{{ viewMode === 'grid' ? 'view_list' : 'view_module' }}</mat-icon>
        </button>
        <button mat-icon-button (click)="toggleSort()" [title]="getSortTooltip()">
          <mat-icon>{{ getSortIcon() }}</mat-icon>
        </button>
      </div>
    </div>

    <!-- Filtros Rápidos -->
    <div class="quick-filters">
      <button 
        mat-stroked-button 
        [class.active]="availabilityFilter === 'all'"
        (click)="setAvailabilityFilter('all')">
        {{ 'filterAll' | translate }} ({{ getTotalFilteredProducts() }})
      </button>
      <button 
        mat-stroked-button 
        [class.active]="availabilityFilter === 'available'"
        (click)="setAvailabilityFilter('available')">
        {{ 'filterAvailable' | translate }} ({{ getAvailableCount() }})
      </button>
      <button 
        mat-stroked-button 
        [class.active]="availabilityFilter === 'unavailable'"
        (click)="setAvailabilityFilter('unavailable')">
        {{ 'filterUnavailable' | translate }} ({{ getUnavailableCount() }})
      </button>
    </div>

    <!-- Grid de Productos -->
    <div class="products-container" [class.list-view]="viewMode === 'list'">
      <div 
        *ngFor="let product of getFilteredProducts(); trackBy: trackByProductId" 
        class="product-item"
        [class.list-item]="viewMode === 'list'"
        [class.unavailable]="!product.hasAvailability">
        
        <div class="product-image-container">
          <img 
            [src]="product.image_url || '/assets/images/products/por-defecto.png'" 
            [alt]="product.name" 
            class="product-image"
            (error)="onImageError($event)">
          <div class="product-status-indicator" [class.available]="product.hasAvailability"></div>
        </div>
        
        <div class="product-info">
          <h4 class="product-name">{{ product.name }}</h4>
          <p class="product-sku">{{ product.sku }}</p>
          <div class="product-meta">
            <span class="warehouse-info">
              <mat-icon>warehouse</mat-icon>
              {{ getWarehouseName(product.warehouse?.toString() || '') }}
            </span>
          </div>
        </div>
        
        <div class="product-availability">
          <div class="availability-badge" [class]="getStockStatusClass(product)">
            <mat-icon>
              <span *ngIf="getStockStatus(product) === 'available'">check_circle</span>
              <span *ngIf="getStockStatus(product) === 'low-stock'">warning</span>
              <span *ngIf="getStockStatus(product) === 'out-of-stock'">cancel</span>
            </mat-icon>
            <span class="stock-text">
              {{ getStockStatusText(product) }}
            </span>
          </div>
        </div>
        
        <div class="product-actions">
          <button 
            mat-flat-button 
            color="primary" 
            (click)="onViewLocations(product)"
            [disabled]="!product.hasAvailability"
            class="action-button">
            <mat-icon>location_on</mat-icon>
            {{ 'viewLocations' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Paginación -->
    <mat-paginator
      *ngIf="getTotalFilteredProducts() > pageSize"
      [length]="getTotalFilteredProducts()"
      [pageSize]="pageSize"
      [pageIndex]="currentPage"
      (page)="onPageChange($event)"
      [pageSizeOptions]="paginationOptions">
    </mat-paginator>
  </div>

  <!-- Estados vacíos -->
  <div class="empty-state" *ngIf="!loading && filteredProducts.length === 0 && searchQuery">
    <mat-icon class="empty-icon">inventory_2</mat-icon>
    <h3>{{ 'noProductsFound' | translate }}</h3>
    <p>{{ 'noProductsMessage' | translate }}</p>
  </div>

  <div class="empty-state" *ngIf="!loading && filteredProducts.length === 0 && !searchQuery">
    <mat-icon class="empty-icon">search</mat-icon>
    <h3>{{ 'searchProductsTitle' | translate }}</h3>
    <p>{{ 'searchProductsMessage' | translate }}</p>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>{{ 'loadingProducts' | translate }}</p>
  </div>
</section>

<!-- Popup de ubicaciones -->
<div class="popup-overlay" *ngIf="showLocationPopup" (click)="closeLocationPopup()">
  <div class="popup-content" (click)="$event.stopPropagation()" *ngIf="selectedProduct">
    <div class="popup-header">
      <h3 class="popup-title">{{ selectedProduct.city_name || getCityName(selectedProduct.city?.toString() || '') }} > {{ selectedProduct.warehouse_name || getWarehouseName(selectedProduct.warehouse?.toString() || '') }}</h3>
      <button class="close-button" (click)="closeLocationPopup()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="popup-body">
      <div class="product-info">
        <h4 class="product-name">{{ selectedProduct.name }}</h4>
        <p class="product-sku">{{ 'skuLabel' | translate }} {{ selectedProduct.sku }} • {{ 'totalLabel' | translate }}: {{ selectedProduct.totalAvailable }}</p>
      </div>
      
      <div class="location-details" *ngIf="selectedProduct.locations && selectedProduct.locations.length > 0">
        <h5 class="location-title">{{ 'physicalLocationTitle' | translate }}</h5>
        <div class="location-grid">
          <div class="location-item">
            <span class="location-label">{{ 'locationSection' | translate }}</span>
            <span class="location-value">{{ selectedProduct.locations[0].section || ('notAvailable' | translate) }}</span>
          </div>
          <div class="location-item">
            <span class="location-label">{{ 'locationAisle' | translate }}</span>
            <span class="location-value">{{ selectedProduct.locations[0].aisle || ('notAvailable' | translate) }}</span>
          </div>
          <div class="location-item">
            <span class="location-label">{{ 'locationShelf' | translate }}</span>
            <span class="location-value">{{ selectedProduct.locations[0].shelf || ('notAvailable' | translate) }}</span>
          </div>
          <div class="location-item">
            <span class="location-label">{{ 'locationLevel' | translate }}</span>
            <span class="location-value">{{ selectedProduct.locations[0].level || ('notAvailable' | translate) }}</span>
          </div>
        </div>
      </div>
      
      <div class="lots-section" *ngIf="selectedProduct.locations && selectedProduct.locations.length > 0">
        <h5 class="lots-title">{{ 'lotsDetailTitle' | translate }}</h5>
        <div class="lots-table">
          <div class="table-header">
            <span>{{ 'lotLabel' | translate }}</span>
            <span>{{ 'expiresLabel' | translate }}</span>
            <span>{{ 'availableLabel' | translate }}</span>
            <span>{{ 'reservedLabel' | translate }}</span>
          </div>
          <div class="table-row" *ngFor="let location of selectedProduct.locations">
            <span class="lot-number">{{ location.lot }}</span>
            <span class="expiry-date">{{ formatDate(location.expires) }}</span>
            <span class="available-qty">{{ location.available }}</span>
            <span class="reserved-qty">{{ location.reserved }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
